\section{Determining Hardware Delay} \label{sec:HardwareDelay}

The following section describes a test determining the conversion delay on the chosen implementation platform.

\subsection{Purpose}

The conversion delay inside the platform plays an important part in this project, and has to be measured and accounted for. With the conversion delay determined it is possible to simulate more accurately.

\subsection{AAU number list}
Table \ref{tab:MeasDelayTable} shows the used equipment in the experiment. These items have been selected due to the low frequencies being measured. The Analog Discovery 2 has a bandwidth of 25 Mhz and 100M Samples/s, making the resolution sufficient.  
\begin{table}[H]
	\centering
	\ra{1.3}
	\begin{tabular}{ c c c } \toprule
		{Item}	& {Description} 						& {AAU-no}. \\ \bottomrule 
		1	&	Spectrum Digital TMS320C5515 eZdsp	& NaN	\\
		2	&	Digilent Analog Discovery 2	& NaN		\\
		3	&	DSP Freedom Board Rev. 1 & NaN		\\
		4	&	Computer w. Waveform 2015					& NaN		\\
		\bottomrule
	\end{tabular}
	\caption{Table over equipment used in test.}
	\label{tab:MeasDelayTable}
\end{table}

\subsection{Diagram \& picture of setup}

The TMS320C5515eZdsp is connected to the DSP Freedom board where the TLV320AIC3204 codec is connected via 3.5mm minijack cable (dashed lines) to the board. The oscilloscopes probes are then connected to the on-board BNC connectors. This is shown on figure \ref{fig:SchematicDelayExperiment}. It should be noted that even though the Freedom Board is equipped with 16 kHz first order lowpass filter, the probes were applied "behind" the filters. this can be seen on figure \ref{fig:DelayExperimentSetup}. However the signal should not be affected since the step is 2 Hz in frequency. 

\begin{figure}[H]
	\centering
	\tikzsetnextfilename{DelaySetupExperiment}
	\input{figures/Hardware/DelaySetupExperiment.tex}
	\caption{Schematic overview of the experiment.}
	\label{fig:SchematicDelayExperiment}
\end{figure}


\begin{figure}[H]
	\centering
\includegraphics[width=0.75\textwidth]{Hardware/DelaySetup}
	\caption{Picture of the experiment}
	\label{fig:DelayExperimentSetup}
\end{figure}


\subsection{Settings/Description}
To determine the sampling delay of the system a simple example is used, where the sample is passed through the system without any interaction. This ensures that the minimum time spent for conversion is used. A step on the input signal will result in an delayed output step. The time difference in the steps will directly be seen as the conversion delay of the system. The delay takes into account the needed time for oversampling and reconstruction in the $\Sigma\Delta$-converters.

\subsubsection{Equipment settings}
To ensure that the DSP is running at the desired frequencies, a probing of the development boards XF pin is done. This pin is flipped according to the sampling frequency, shown in listing \ref{lst:samplingbasic}, line 15 \& 19. The output of the 48 and 192 khz is show in figure \ref{fig:countingthefs}. 
\begin{figure}[H]
	\centering
	\begin{subfigure}[b]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{Hardware/48khz}
		\caption{Counter showing the sampling frequency of 48 khz}
		\label{fig:48khzcounter}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{Hardware/192khz}
		\caption{Counter showing the sampling frequency of 192 khz}
		\label{fig:192khzcounter}
	\end{subfigure}	
	\caption{High frequency counter showing the sampling frequency of the DSP}
	\label{fig:countingthefs}
\end{figure}

Listing \ref{lst:samplingbasic} shows the main code for looping the stereo codec. The code shows the sampling of the input register when ready, and writing to the output register when ready. 

\begin{lstlisting} [language=C,label={lst:samplingbasic},caption={The code example used to pass a sample through the DSP and codec}]
void main( void )
{
/* Initialize Board and Codec - look in "aic3204_setup.h" */
USBSTK5515_init();
codec_init ();
%initAll();
while ( 1 )
{
/* Read Digital audio */
while((Rcv & I2S0_IR) == 0);  // Wait for interrupt pending flag
data3 = I2S0_W0_MSW_R;    // 16 bit left channel received audio data
data1 = I2S0_W0_LSW_R;
data4 = I2S0_W1_MSW_R;    // 16 bit right channel received audio data
data2 = I2S0_W1_LSW_R;
asm(" bset XF");	  	  // Set XF flag high

/* Write Digital audio */
while((Xmit & I2S0_IR) == 0);  // Wait for interrupt pending flag
asm(" bclr XF");		   // Set XF flag low
I2S0_W0_MSW_W = data3;     // 16 bit left channel transmit audio data
I2S0_W0_LSW_W = 0;
I2S0_W1_MSW_W = data4;     // 16 bit right channel transmit audio data
I2S0_W1_LSW_W = 0;
}}
\end{lstlisting}



\subsection{Procedure}
\subsubsection{Set-up}
\begin{enumerate}
	\item The DSP is mounted onto the DSP Freedom Board
	\item  Connect the DSP board with 3.5 mm mini-jack cable to Input 1 and 2.
	\begin{enumerate}
		\item This ensures that bypass of the lowpass filters are possible
	\end{enumerate}
	\item Connect OUT1 and IN1 from the oscilloscope to Input 1 on the board with BNC cables.
	\item Connect IN2 from the oscilloscope to the Input 2 on the board.
\end{enumerate}

\subsubsection{Performing the experiment}
\begin{enumerate}
	\item Start Code Composer Studio V.6 and load \path{AIC3204C6.cproject}
	\item Change sampling frequency in \path{aic3204_Setup.h} by changing the defined ADCFs to:
	\begin{enumerate}
		\item 48
		\item 96
		\item 192
	\end{enumerate}
	\item Start Waveform 2015 to control the oscilloscope
	\item The oscilloscope is set to trigger at the rise of IN1
	\item Apply a 2 Hz square wave to OUT1 on the oscilloscope
	\item Save measurement IN1 and IN2 on oscilloscope in a \path{.CSV} file
	\item Repeat with different value in step 6
\end{enumerate}


\subsection{Data extraction}

The data from the experiment is saved as a \path{.CSV} file. These files can be found at:
\begin{itemize}
	\item \path{48kHz2Hz500mV.csv}
	\item \path{96kHz2Hz500mV.csv}
	\item \path{192kHz2Hz500mV.csv}
\end{itemize}

Each file contains the 2 Hz and corresponding output of the codec, with a resolution of 8000 points over a period, T = 1.2 $m$s.


\subsection{Analysis}\label{sec:AnalysisFsDelay}

On figure \ref{fig:ScopeDelayExperiment} the three outputs from each test are plotted on the same figure.

\begin{itemize}
	\item The \textcolor{MATLABblue}{blue} graph shows input step.
	\item The \textcolor{MATLABpurple}{purple} shows the 192 $k$Hz output
	\begin{itemize}
		\item corresponding to 225 $\mu$s
	\end{itemize}
	\item The \textcolor{MATLAByellow}{yellow} shows the 96 $k$Hz output
	\begin{itemize}
		\item corresponding to 450 $\mu$s
	\end{itemize}
	\item The \textcolor{MATLABorange}{orange} shows the 48 $k$Hz output
	\begin{itemize}
		\item corresponding to 900 $\mu$s
	\end{itemize}
\end{itemize}
 

\begin{figure}[H]
	\centering
	\tikzsetnextfilename{DelaySetupCSVRead}
	\input{figures/Hardware/DelayGraph.tex}
	\caption{Readout form the oscilloscope showing steps at different f$_s$ = 2 Hz(blue), f$_s$ = 48 $k$Hz(orange), f$_s$ = 96 $k$Hz(yellow) and f$_s$ = 192 $k$Hz(purple). Note that step has been offset for visual overview.}
	\label{fig:ScopeDelayExperiment}
\end{figure}

In equation \ref{eq:sampleDelay} it is seen that the delay of conversion corresponds to a delay of 43 samples.

\begin{equation}\label{eq:sampleDelay}
	\frac{N}{S} \cdot S = \frac{48000N}{1s} \cdot 900\cdot 10^{-6}\text{s} = 43 \text{ Samples [N]} 
\end{equation}



%\begin{table}[H]
%	\centering
%	\begin{tabular}{ccc}
%		Fs[kHz] & Delay [$\mu$ S] & Delay [n] \\ \hline \hline
%		48 & 900 & 43 \\ 
%		96 & 450 & 43 \\ 
%		192 & 225 & 43
%	\end{tabular} 
%	\caption{The measured delay in both time and samples according to the sampling frequency}
%	\label{tab:DelayResults}
%\end{table}


\subsection{Accuracy \& error sources}

The steps are captured using a single 8000-points frame, as shown in figure \ref{fig:ScopeDelayExperiment}. It is seen that the output was noisy and had a slew-rate of $\pm$ 10 $\mu $s on all trails. The measurements noted in section \ref{sec:AnalysisFsDelay} were measured at the start of the step eliminating the effect of the slew-rate. However if implemented this has to be taken into account.

\subsection{Conclusion}
The conversion delay of the chosen platform is too large to be efficient for an actual implementation. The delay of the system forces it to become non-causal, deeming the platform not suitable for implementation. It should however be noted that a change in converter type or samplerate could solve the problem, this has not been further analyzed due to the scope of this project.



