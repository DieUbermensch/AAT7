
\section{The Angle of Incidences' Influence on the Headphone Transfer Function} \label{sec:AngleOfIncidence}

All data from this experiment can be found at
 \path{CD:\\Appendices\Appendix H - The Angles of Incidences Influence on the Headphone Transfer-Function\..}

\subsection{Purpose}
The purpose of this experiment is to determine if the angle of incidence has any influence on the headphone transfer function (HP). 

The hypothesis is that the angle on incidence will influence both the time delay and magnitude response of the transfer functions. Measurements will only be performed in a horizontal plane. 

\subsection{AAU number list}

%Table \ref{tab:AngleOfIncideceHP} list the equipment used during the experiment.

\begin{table}[H]
	\centering
	\ra{1.3}
	\begin{tabular}{ c c c } \toprule
		{Item}	& {Description} 						& {AAU-no}. \\ \bottomrule 
		1	&	B\&K Head And Torso Simulator "Henry" Type 4128	& 08453	\\
		2	&	B\&K Â½'' Condenser Microphone Type 4134 	& 08130		\\
		3	&	Beyerdynamic DT 770 Headphones				& 2037-18		\\
		4	&	Soundcard RME Fireface 802					& 86838		\\
		5	&	Computer running Simulink								& NaN		\\
		6	&	G.R.A.S. 26-AK Standard Preamplifier		& 52665		\\
		7	&	B\&K Sound Calibrator Type 4230				& 08155		\\ 
		8	&	Knowles FG-23329 Microphone					& NaN		\\
		9	&	Genelec 1031-A Loudspeaker								& 33990		\\ 
		10	&	PSU for FG-23329  Microphone	& NaN\\
		11	& 	B\&K Microphone Power Supply Type 2804		& 07304		\\
		\bottomrule
	\end{tabular}
	\caption{Table over equipment used during the experiment.}
	\label{tab:AngleOfIncideceHP}
\end{table}

% \subsubsection{Choice of equipment}
% %The experiment aims to be valid in the frequency range 50 Hz to 20 $k$Hz. This means that all equipment used should work within the span of this frequency range. \\\\
% The experiment uses a total of three microphones:
% \begin{itemize}
% 	\item The error microphone; located inside the HATS's ear is given by the type fitted to the dummy.
% 	\item The spmMic; it should be as small as possible in order to avoid influencing the transfer functions that are being measured.
% 	\begin{itemize}
% 		\item For this a Knowles FG-23329 is used.
% 	\end{itemize}
% 	\item The Ref microphone; this has less restrictions on size and placement. This allows for the choice of a standard measurement microphone.
% 	\begin{itemize}
% 		\item The B\&K 4134 is chosen.
% 	\end{itemize}
% 	\item For the loudspeaker; the limiting criterion of this is the lower roll of. However transfer functions between the microphones are measured, so absolute flatness is not critical.
% 	\begin{itemize}
% 		\item The Genelec 1031-A is used as sound source.
% 	\end{itemize}
% 	\item The measurement system uses a RME Fireface 802 controlled using Simulink. Impulse responses are calculated using the method described in \autoref{Sec:MeasATransFunc}. 
% \end{itemize}

\subsection{Diagram}

Figure \ref{fig:AngleOfIndDiagram} shows the set-up of the experiment. When rotating the head, different angles between the line created by the three microphones and the loudspeaker is obtained. The angle is adjusted between measurements as described in section \ref{sec:AngleDescription}. %It is possible to determine the angle by measuring the difference in time of arrival between the speaker microphone and reference microphone. This is further described in section \ref{sec:AngleDescription}.
\begin{figure}[H]
	\centering
	\begin{subfigure}[b]{.4\textwidth}
		\includegraphics[width=\textwidth]{../Journal/Experiments/AngleOfIncidence/AngleOfIncidenceOnAxis.pdf}
		\caption{On axis.}
		\label{fig:AngOfIndOnax}
		\vspace{2ex}
		\includegraphics[width=\textwidth]{../Journal/Experiments/AngleOfIncidence/AngleOfIncidenceOffAxis.pdf}
		\caption{Off axis.}
		\label{fig:AngOfIndOffax}
	\end{subfigure} 
	\begin{subfigure}[b]{.4\textwidth}
	\centering
	\includegraphics[width=\textwidth]{../Journal/Experiments/AngleOfIncidence/AngleOfIncidenceSchematic.pdf}
	\caption{Placement of microphones.}
	\label{fig:AngOgIndMicplace}
\end{subfigure}
	\caption{Placement of microphones and rotation.}
	\label{fig:AngleOfIndDiagram}
\end{figure}
The connections in the set-up can be seen in \autoref{Fig:AngleOfIncidenceSetup}
\begin{figure}[H]
	\centering
	\includegraphics[width=\textwidth]{../Journal/Experiments/AngleOfIncidence/AngleOfIncidenceSetup.pdf}
	\caption{Setup of experiment on angle of incidence.}
	\label{Fig:AngleOfIncidenceSetup}
\end{figure}



\subsection{Settings/Description}\label{sec:AngleDescription}
The experiment uses a single loudspeaker to measure the  different angles of incidence, thus either the loudspeaker has to be moved around the center of the HATS, or the HATS will have to be rotated on its axis to the right angles. \\\\
It was chosen to adjust the angle by rotating the HATS around the center of its own axis, leaving the loudspeaker in place. This creates a triangle between the loudspeaker, microphone and inner microphone of the HATS. The resolution of the scale on the HATS is 2\degrees. The baseline of the triangle is from the microphone to the inner microphone, and angle is adjusted according to that line.
Measurements are made for the following angles:
\begin{table}[H]
	\centering
	\begin{tabular}{c c c c c c c c c c} \toprule
		0\degrees & 10\degrees & 20\degrees & 30\degrees & 40\degrees & 50\degrees & 60\degrees & 70\degrees & 80\degrees & 90\degrees \\ \bottomrule
	\end{tabular}
\caption{Angles that measurements should be performed at 0\degrees  is the situation in \autoref{fig:AngOfIndOnax}.}
\label{Tab:AngleOfInciMeasAngles}
\end{table}
 

 
\subsubsection{Control and calibration} \label{sec:calAngInc}

\begin{itemize}
	\item For the Ref microphone, calibration is made at 1 $k$Hz using the B\&K 4230 as calibrator. This should yield a signal of 93.6 dB as it is a pressure field microphone. The measured intensity in Matlab was 68.99 dB so all measurements are multiplied by 17.00 to get a calibrated signal in Matlab. 
	\item For the Error microphone, calibration is made at 1 $k$Hz using the B\&K 4230 as calibrator with adapter B\&K 0741 for the ear of the HATS. This should yield a signal of 95.6 dB, according to the datasheet of the HATS. The measured intensity in Matlab was 78.22 dB so all measurements are multiplied by 7.40 to get a calibrated signal in Matlab. 
	\item For the speakerMic, calibration is made using a earplug cut in half and fitted around the microphone, as an adapter. This simple adapter allows the B\&K 4230 to be used as calibrator. The measured output level is 84.37 dB, and should have been 94.0 dB . Therefore all measurements are multiplied by 3.03 to get a calibrated signal in Matlab
\end{itemize} 
 
\subsubsection{Equipment settings}\label{sec:SettingsAngInc}
\begin{itemize}
	\item This experiment is performed with a sampling rate of, $f_{s}$ = 48 $k$Hz.
	\item The loudspeaker is placed 1.6 meters from the center of the HATS.
	\item The spmMic is fitted just in front of the headphone loudspeaker using medical tape 8.85 $c$m from the center of the HATS.
	\item The Ref microphone is placed just outside the headphone in-line with the ear and loudspeaker unit 12.45 $c$m from the center of the HATS. 
	\item The spmMic is placed inside the headphone, as close to the loudspeaker unit as possible. 
	\item For the RME Fireface 802 the "inst"-option is turned on in the mixing console. The following gain settings are present: 		
	\begin{itemize}
		\item Line level gain is 0 dB
		\item Error Microphones has gain +30 dB
		\item Ref Microphones has gain +48 dB
		\item Speaker Microphones has gain +48 dB
	\end{itemize}
	\item All settings on the computer is set to 0 dBFS.
	\item A logarithmic sine sweep is generated and saved in Matlab using the chirp function as follows:
	\begin{lstlisting} [language=Matlab, caption=Matlab code generating a logarithmic chirp.	]
	fs=48000;
	f1=50;
	f2=fs/2;
	t=0:1/fs:5-1/fs;
	t2=5;
	sweep=chirp(t,f1,t2,f2,'logarithmic',90);
	sweep=[zeros(1,fs) sweep zeros(1,fs)];
	audiowrite('LogChirp.wav', sweep,fs);
	
	\end{lstlisting}
	Resulting in a five seconds long logarithmic sweep from 50 Hz -- 24 $k$Hz.
\end{itemize} 
 
% \subsection{Pictures}
% The following Matlab code is used to calculate the angles at which measurements should be performed. The first measurement is performed at a 180\degrees angle. This determines the length of the baseline (maxI in the code below). After determining the angles of interest can be calculated.  \\
%The script is based on two triangles that share a corner, the turning point, and a side to the speaker. The two triangles share the same angle at the turning point. This creates for two equations with two unknowns using the cosine relation and the fact that the side opposite the turning point should have a length "x" in one triangle and "x" + an amount of samples in the other triangle. Using this the angle can  be found.

%\begin{figure}[H]
%%	\includegraphics[width=\textwidth]{../Journal/Experiments/AngleOfIncidence/TriangleCalculation.pdf}
%\tikzsetnextfilename{AngleOfIcidenceTriangleCalculation}
%\begin{tikzpicture}
%\draw (4,0) node (v3) {} -- (-1,0);
%\draw (-1,0) -- (-3,0);
%\draw (-3,0) -- (-3,-0.6);
%\draw (-1,0) node (v1) {} -- (-1,-0.6);
%\draw (-5,5) node (v2) {} -- (-1,0) -- (-5,5) node (v4) {} -- (-3,0);
%\draw (4,0) -- (-5,5);
%\node at (-5.1,5.7) {Speaker};
%\node at (-3,-0.9) {spmMic};
%\node at (-1,-0.9) {Ref};
%\node at (5.3,-0.1) {Turning Point};
%\node at (2.8,0.2) {Angle};
%\node at (0.7,2.5) {$Dist_{Speaker}$};
%\node at (-1.9,2) {$x+i$};
%\node at (-4.2,2) {$x$};
%\end{tikzpicture}
%\label{Fig:AngleOfIcidenceTriangleCalculation}
%\caption{The two triangles spanned by the center of the HATS, the speaker and two of the microphones.}
%\end{figure}  

\subsection{Pictures}
A picture of the set-up is shown in figure \ref{AngIncidenceSetup}. The reference microphone is fixed to the outside of the headphone cup using thick metal wire and a glue gun.  
\begin{figure}[H]
	\includegraphics[width=\textwidth]{../Journal/Experiments/AngleOfIncidence/AngInSetup.jpg}
	\caption{Set-up of the experiment.}
	\label{AngIncidenceSetup}	
\end{figure}


\subsection{Procedure}
\subsubsection{set-up}
\begin{enumerate}
	\item Set instruments to comply with the list in \ref{sec:SettingsAngInc}.
	\item Calibrate the microphones using the calibrator as described in \autoref{sec:calAngInc}.
	\item Place the headphone on the HATS.
	\item Connect the microphone to their power supplies as shown in \autoref{Fig:AngleOfIncidenceSetup}. 
	\item Connect the power supplies to the RME Fireface 802 as shown in \autoref{Fig:AngleOfIncidenceSetup}. 
	\item Connect the RME Fireface 802 to the computer via USB.
	\item Connect the Genelec loudspeaker to Out1L on the RME Fireface 802.
	\item Connect a loopback from the Out1R to In1L on the RME Fireface 802.
\end{enumerate}


\subsubsection{Performing the experiment}
\begin{enumerate}
	\item Set the HATS to the desired test angle. 
	\item Open Simulink and run file \path{SimulinkAngleOfIndence.slx}.
	\item Record and save, and name \path{Mic[i].wav}, \path{SpM[i].wav}, \path{loop[i].wav} and \path{Ref[i].wav}\footnote{[i] indicates the angle of the experiment}.
	\item Repeat the experiment for all angles in \autoref{Tab:AngleOfInciMeasAngles}.
\end{enumerate}



\subsection{Data extraction}

All data is automatically stored when the script \path{SimulinkAngleOfIndence.slx} is run. The only action to be taken is changing the name of the files after each measurement, so the angle under test is in the file name.


From performing the experiment, 40 files have been generated:
\begin{itemize}
	\item HPError0Deg.wav -- HPError90Deg.wav
	\item HPRef0Deg0.wav -- HPRef0Deg90.wav
	\item HPspeakerMic0Deg.wav -- 	HPspeakerMic90Deg.wav
	\item Loop0Deg.wav -- Loop90Deg.wav
\end{itemize}

\subsection{Analysis}
The analysis is performed using the script: \path{AngleOfIncidenceDataExtract.m}.
The impulse response and frequency response of the HP is to be found for all angles.
Note that the Ref microphone has a 180$^\circ$ phase inversion. Therefore all impulses are inverted. When the data is later used it should be inverted again to yield the correct phase \cite{michandbook}.

The cross correlation method described in \autoref{Sec:MeasATransFunc} is used to find the transfer functions. The Reference microphone is used as input signal and the speakerMic is used as output. The system under test is the cup of the headphone. 
Below the frequency response and time response of the system is plotted for all angles. 
\begin{figure}[H]
	\tikzsetnextfilename{AngOfIncFreq}
	\input{../Journal/Experiments/AngleOfIncidence/AngOfIncFreq.tex}
	\caption{Transfer Function from Ref to Genelec in frequency domain. 10$^\circ$(\textcolor{MATLABblue}{---}), 
	20$^\circ$(\textcolor{MATLABorange}{---}), 	
	30$^\circ$(\textcolor{MATLAByellow}{---}), 	
	40$^\circ$(\textcolor{MATLABpurple}{---}), 	
	50$^\circ$(\textcolor{MATLABgreen}{---}), 	
	60$^\circ$(\textcolor{MATLABbabyblue}{---}), 	
	70$^\circ$(\textcolor{MATLABred}{---}), 	
	80$^\circ$(\textcolor{MATLABblue}{---}), 	
	90$^\circ$(\textcolor{MATLABorange}{---}).			
		}
	\label{Fig:AngOfIncFreq}
\end{figure}
It can be seen that the frequency response varies above 500 Hz with different angle of incidences. %This means that in the ANC headphone the model of HP transfer function should vary with the angle of incidence.  


Figure \ref{Fig:AngOfIncTime} shows the first 960 filter coefficients of a FIR-filter with the same frequency response as the cup of the headphone. The coefficients are obtained by taking the IFT of the frequency response and truncating so only the first 960 samples are used.   The delay between the impulses is of interest, therefore a plot with a zoom is shown in \autoref{Fig:AngOfIncTimezoom2}. \\\\
As expected the impulses are approximately delayed versions of each other. The on axis (0\degrees) yields the longest delay between the Ref microphone and spmMic. The 90\degrees case yields no delay at all. 


\begin{figure}[H]
	\centering
	\begin{subfigure}[b]{\textwidth}
	\tikzsetnextfilename{AngOfIncTime}
	\input{../Journal/Experiments/AngleOfIncidence/AngOfIncTime.tex}
	\caption{Transfer function from reference microphone to Genelec - showing 960 samples.
		10$^\circ$(\textcolor{MATLABblue}{---}), 
		20$^\circ$(\textcolor{MATLABorange}{---}), 	
		30$^\circ$(\textcolor{MATLAByellow}{---}), 	
		40$^\circ$(\textcolor{MATLABpurple}{---}), 	
		50$^\circ$(\textcolor{MATLABgreen}{---}), 	
		60$^\circ$(\textcolor{MATLABbabyblue}{---}), 	
		70$^\circ$(\textcolor{MATLABred}{---}), 	
		80$^\circ$(\textcolor{MATLABblue}{---}), 	
		90$^\circ$(\textcolor{MATLABorange}{---}).			
		}
	\label{Fig:AngOfIncTime}
	\end{subfigure} 
	\begin{subfigure}[b]{\textwidth}
	\tikzsetnextfilename{AngOfIncTimeZoom}
	\input{../Journal/Experiments/AngleOfIncidence/AngOfIncTimeZoom.tex}
	\caption{Zoomed graph of figure \ref{Fig:AngOfIncTime}, showing the first 30 Samples.
		10$^\circ$(\textcolor{MATLABblue}{---}), 
		20$^\circ$(\textcolor{MATLABorange}{---}), 	
		30$^\circ$(\textcolor{MATLAByellow}{---}), 	
		40$^\circ$(\textcolor{MATLABpurple}{---}), 	
		50$^\circ$(\textcolor{MATLABgreen}{---}), 	
		60$^\circ$(\textcolor{MATLABbabyblue}{---}), 	
		70$^\circ$(\textcolor{MATLABred}{---}), 	
		80$^\circ$(\textcolor{MATLABblue}{---}), 	
		90$^\circ$(\textcolor{MATLABorange}{---}).			
		}
	\label{Fig:AngOfIncTimezoom2}
	\end{subfigure}
	\caption{The transfer function showed at different angles with a incrementation of $10^{\circ}$.}
	\label{fig:AngOfIncResult}
\end{figure}

\subsection{Error sources}
The SpeakerMic is mounted inside the cup of the headphone. This influences the compartment inside the headphone. Futhermore the wire connecting the SpeakerMic to its power supply went between the headphone and the dummy, influencing the HP transfer function in an uncontrolled way. The results are consistent, but might deviate from reality.
\todoKiis{Missing a TABLE of tolerances I KNOW} 

\subsection{Conclusion}
The angle of incidence influences both the frequency and the time response of the HP transfer function.  The largest time difference is achieved when sound propagates from the side of the wearer. If sound comes from the front there is no time difference at all. 