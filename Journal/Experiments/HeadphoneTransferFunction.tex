\section{Headphone Transfer-Function}
\subsection{Purpose}
The purpose of the experiment is to determine the impulse response of of the  headphones, i.e. the transfer-function between the 'reference-microphone' and the 'source-loudspeaker'

\subsection{AAU number list}
\begin{table}[H]
	\centering
	\ra{1.3}
	\begin{tabular}{ c c c } \toprule
		{Item}	& {Description} 						& {AAU-no}. \\ \bottomrule 
		1	&	B\&K Head And Torso Simulator "Henry" Type 4128	& 08453		\\
		2	&	B\&K 1'' Condenser Microphone Type 4179 & 08024\\
		%2	&	B\&K \textonehalf'' Condenser Microphone Type 4134 & 61447\\
		3	&	Sennheiser HD 200	Headphones			& 33379		\\
		4	&	Roland Edirol UA-25EX Audio Capture		& 64696		\\
		5	&	Vision B3565 Computer					& NaN		\\
		%6	&	B\&K Microphone Power Supply Type 2804	& 07304		\\
		6	&	B\&K Measuring Amplifier Type 2636	& 08717		\\
		%7	&	B\&K Sound Calibrator Type 4231			& 78301		\\ 
		7	&	B\&K Sound Calibrator Type 4230			& 08155		\\ 
		8	&	B\&K 1'' Microphone Preamplifier Type 2660	& 08025		\\
		%8	&	G.R.A.S. Type 26AK \textonehalf'' Standard Preamplifier	& 52665		\\ 
		%7	&	B\&K Sound Intensity Calibrator Type 3541	& 08597	\\ 
		\bottomrule
	\end{tabular}
	\caption{Table over equipment used in test.}
	\label{tab:UsedEquipmentListningHP}
\end{table}

\subsection{Diagram}
%\begin{figure}[H]
%	\centering
%	\includegraphics[width=0.7\textwidth]{Schematic_HeadPhones.pdf}
%	\caption{Schematic of the Setup.}
%	\label{Schematic}
%\end{figure}


\begin{figure}[H]
	\centering
	\tikzsetnextfilename{Setup}
	\input{figures/CancellationPath_MATLAB_Figures/Headphone.tex}
	\caption{test}
	\label{test}
\end{figure}

\subsection{Settings/Description}
\label{SettingsHeadPhones}

Calibration of the microphone and associated preamplifier is done on the measurement amplifier, but any other method can be used. The following setting is present:
\subsubsection{Control and calibration}
\begin{itemize}
	\item 93.6 dB @ 1000 Hz is used as calibration signal
	\item Microphone sensitivity is controlled to 110 $m$V/Pa
	\item Measurement amplifier is set to -10 dB default
	\item Calibration signal yields an amplitude of 0.87 relative to 0 dBFS
\end{itemize}
\subsubsection{Equipment settings}
\begin{itemize}
	\item This experiment is performed with a sampling rate of, $F_{s}$ = 24,000 Hz
	\item Outside microphone is placed 12.6 mm from headphone cup
	\item For item 4 (sound capture card):
	\begin{itemize}
		\item "SENS(INPUT 1/L)" is set to +0 dB"
		\item "SENS(INPUT 2/R)" is set to +0 dB"
		\item "PHONES" is set to maximum volume
	\end{itemize}		
	\item For item 6 (measuring amplifier):
		\begin{itemize}
			\item "Input Section Gain" is set to +20 dB in proportion to calibration
			\item 22.4 $k$Hz low-pass filter is enabled
			\item 22.4 $k$Hz high-pass filter is enabled 
		\end{itemize}
	\item Item 5 (computer) is set to 0 dBFS
\end{itemize}



\subsubsection{Picture}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{CancellationPath_and_Headphones/CloseUpMicNew.jpg}
	\caption{Full setup of experiment.}
	\label{CloseupCancellationPath}
\end{figure}

%\begin{figure}[H]
%	\centering
%	\includegraphics[width=0.8\textwidth]{CancellationPath_and_Headphones/CloseUpMic.jpg}
%	\caption{Close up of experiment.}
%	\label{CloseUpCancellationPath}
%\end{figure}

\subsection{Procedure}
\subsubsection{Set-up}
\begin{enumerate}
	\item Set instruments to comply with the list in \ref{SettingsHeadPhones}
	\item Control, and if necessary, calibrate item 2 using item 7
	\item Place item 3 onto item 1 ("Henry"'s head and ears)
	\item Insert item 2's onto item 8 and connect to input of item 6
	\item Connect item 6 to item 4 and connect item 4 to item 5 via USB
	\item Insert item 3's connector into output of item 4
\end{enumerate}

\subsubsection{Performing the experiment}
\begin{enumerate}
	\item Open Simulink\textsuperscript{\textregistered} and run file "SimulinkSystemHeadPhone.xls"
	\item Through Simulink\textsuperscript{\textregistered} play "LogChirp.wav" from item 5 via item 4
	\item Record and save, and name "Mic[i].wav" and Ref[i].wav" from item 4 onto item 5 \footnote{[i] indicates the iteration of the experiment}
	\begin{itemize}
		\item[] Perform this experiment for a total of 5 times
	\end{itemize}
\end{enumerate}


\subsubsection{Data Extraction}
\begin{enumerate}
	\item Place generated .wav-files in same folder as MATLAB\textsuperscript{\textregistered}-script "HeadPhoneScript.m".
	\item Open MATLAB\textsuperscript{\textregistered} and run script "CancellationPathScript.m"
\end{enumerate}
This should yield the resulting frequency response, impulse response and finally the transfer function, along other information about the headphones in this set-up.


%In MATLAB\textsuperscript{\textregistered} run script: "Headphone\_TF.m" and load file "Headphone\_Path\_1.wav". This should yield the resulting transfer-function and other information about the headphones used in this set-up.\\
%\indent The script takes the sound played by the headphones (Item 2) , applies FFT, and takes the inverse of the result. This result is then convolved with the FFT of the sound picked up by the microphone (Item 5). This yields an impulse response, which is used to determine the transfer-function.
%\todo[inline]{Tjek lige det her}

\subsection{Analysis}
From the performing of the experiment, 10 files has been generated:
\begin{itemize}
	\item HPMic1.wav - HPMic5.wav
	\item HPRef1.wav - HPRef5.wav
\end{itemize}

These files are the results of performing the six second simulation which gives a number of 288,768 samples, for each generated .wav-file.
An example showing outputted Mic1 and Ref1 are shown in  \autoref{HeadPhoneAmplitudePlot}.

%\begin{figure}[H]
%	\centering
%	\tikzsetnextfilename{HeadPhoneAmplitudePlot}
%	\input{figures/CancellationPath_MATLAB_Figures/HeadPhoneAmplitudePlot.tex}
%	\caption{Amplitude plot of the cancellation path.}
%	\label{HeadPhoneAmplitudePlot}
%\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.85\textwidth]{HeadPhone_MATLAB_Figures/HeadPhoneAmplitudePlot.png}
	\caption{Amplitude plot of the headphones (NOT TIKZ).}
	\label{HeadPhoneAmplitudePlot}
\end{figure}


Here the frequency response of the cancellation path is to be found. This is defined as the FT (Fourier Transform) of the cross correlation between Mic[i] and Ref[i] and is given by:


\begin{equation}\label{FrequencyResponseEq}
	H(f) = \frac{Y(f) \cdot X\textsuperscript{*}(f)}{X(f) \cdot X\textsuperscript{*}(f)}
\end{equation}
Where:
\begin{itemize}
	%\item " $*$ " denotes the complex conjugation
	\item $H(f)$ is the FT of the 'Cancellation Path'
	\item $Y(f)$ is the recorded microphone signals, Mic[i]
	\item $X(f)$ is the recorded reference signals, Ref[i]
\end{itemize}

The frequency response of the headphones path is shown at \autoref{HeadPhoneFrequencyResponsePlot}.

\begin{figure}[H]
	\centering
	\tikzsetnextfilename{HeadPhoneFrequencyResponse}
	\input{figures/HeadPhone_MATLAB_Figures/HeadPhoneFrequencyResponse.tex}
	\caption{Frequency Response plot of the headphones}
	\label{HeadPhoneFrequencyResponsePlot}
\end{figure}



The impulse response of this system is found by taking the IFT (Inverse Fourier Transform) of the frequency response.
The impulse response looks as shown on \autoref{HeadPhoneImpulseResponse}.


\begin{figure}[H]
	\centering
	\tikzsetnextfilename{HeadPhoneImpulseResponse}
	\input{figures/HeadPhone_MATLAB_Figures/HeadPhoneImpulseResponse.tex}
	\caption{Impulse Response plot of the headphones }
	\label{HeadPhoneImpulseResponse}
\end{figure}

%\begin{figure}[H]
%	\centering
%	\tikzsetnextfilename{CancellationPathImpulseResponse}
%	\input{figures/CancellationPath_MATLAB_Figures/CancellationPathImpulseResponse.tex}
%	\caption{Frequency Response plot of the cancellation path}
%	\label{CancellationPathImpulseResponse}
%\end{figure}

Converting the impulse response from magnitude to dB, gives the time decay which reveals the SNR (Signal to Noise Ratio) of the system, and from the read off SNR is found to be $\sim$ 50 dB SNR.

\begin{figure}[H]
	\centering
	\tikzsetnextfilename{TimeDecayPlotCancellationPath}
	\input{figures/CancellationPath_MATLAB_Figures/TimeDecayPlotCancellationPath.tex}
	\caption{Time Decay plot of the cancellation path}
	\label{TimeDecayPlotHeadphone}
\end{figure}




\subsection{Error Sources}
\begin{itemize}
	\item Placement of the actuators and test-devices
	\item Instrument inaccuracies see \autoref{TolerancesHP}
	\item Movement of instruments
	\item Low-frequency background noise
\end{itemize}

\begin{table}[H]
	\centering
	\ra{1.3}
	\begin{tabular}{ c c l } \toprule
	{Item}	& 		{Description} 							& {Tolerance ([dB])}.\\ \bottomrule 
		2	&	B\&K 1'' Condenser Microphone Type 4179 	& $\pm$ 1		\\
		3	&	Sennheiser HD 200 Headphones				& $\pm$ 3.0		\\
		4	&	Roland Edirol UA-25EX Audio Capture			& $\pm$ 1.0		\\
		6	&	B\&K Measuring Amplifiers Type 2636			& $\pm$ 0.5		\\
		7	&	B\&K Sound Calibrator Type 4230				& $\pm$ 0.3		\\ 
		8	&	B\&K 1'' Microphone Preamplifier Type 2660	& $\pm$ 0.1		\\ \bottomrule
			&	Total tolerance								& $\pm$ 5.9		\\ \bottomrule	
	\end{tabular}
	\caption{Table showing error tolerances for used equipment.}
	\label{TolerancesHP}
\end{table}

\subsection{Conclusion}
The impulse response on \autoref{HeadPhoneImpulseResponse} shows the coefficients of the system, and a file containing all 250 is generated with the name "CoeffientsHP.mat"