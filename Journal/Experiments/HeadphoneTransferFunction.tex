\section{Headphone Transfer-Function} \label{sec:HPjournal}
\textbf{Note:} This was the initial experiment to determine the impulse response of the used headphone, later the headphone was changed and a new experiment was done. The results of this experiment are therefore obsolete. The new experiment can be seen in \autoref{sec:AngleOfIncidence}.

All files from this appendix can be found in folder: \\
\path{Attachment://Appendix I - Headphone Transfer-Function}

\subsection{Purpose}
The purpose of this experiment is to determine the dampening of the headphones, i.e. the transfer function between the reference microphone and the headphone loudspeaker.

\subsection{AAU number list}
\begin{table}[H]
	\centering
	\ra{1.3}
	\begin{tabular}{ c c c } \toprule
		{Item}	& {Description} 						& {AAU-no}. \\ \bottomrule 
		1	&	B\&K Head And Torso Simulator "Henry" Type 4128	& 08453		\\
		2	&	B\&K 1'' Condenser Microphone Type 4179 & 08024\\
		%2	&	B\&K \textonehalf'' Condenser Microphone Type 4134 & 61447\\
		3	&	Sennheiser HDA 200	Headphones			& 33379		\\
		4	&	Roland Edirol UA-25EX Audio Capture		& 64696		\\
		5	&	Computer running Simulink					& NaN		\\
		%6	&	B\&K Microphone Power Supply Type 2804	& 07304		\\
		6	&	B\&K Measuring Amplifier Type 2636	& 08717		\\
		%7	&	B\&K Sound Calibrator Type 4231			& 78301		\\ 
		7	&	B\&K Sound Calibrator Type 4230			& 08155		\\ 
		8	&	B\&K 1'' Microphone Preamplifier Type 2660	& 08025		\\
		%8	&	G.R.A.S. Type 26AK \textonehalf'' Standard Preamplifier	& 52665		\\ 
		%7	&	B\&K Sound Intensity Calibrator Type 3541	& 08597	\\ 
		\bottomrule
	\end{tabular}
	\caption{Table over equipment used in test.}
	\label{tab:UsedEquipmentListningHP}
\end{table}

\subsection{Diagram}
%\begin{figure}[H]
%	\centering
%	\includegraphics[width=0.7\textwidth]{Schematic_HeadPhones.pdf}
%	\caption{Schematic of the Setup.}
%	\label{Schematic}
%\end{figure}


\begin{figure}[H]
	\centering
	\tikzsetnextfilename{Set-up}
	\input{figures/CancellationPath_MATLAB_Figures/Headphone.tex}
	\caption{Total overview of the test set-up.}
	\label{SchematicOverviewHP}
\end{figure}
%\todoKiis{In the CP experiment the measurement amplifier was in the anechoic - did that change for this experiment?}
\subsection{Settings/Description}
\label{SettingsHeadPhones}
Calibration of the microphone and associated preamplifier is done on the computer using Simulink. The following settings are present:

\subsubsection{Control and calibration}
\begin{itemize}
	\item Microphone sensitivity is controlled to 110 $m$V/Pa.
	\item Measurement amplifier is set to -10 dB default.
	%\item Calibration signal yields an amplitude of 0.87 relative to 0 dBFS. \todoKiis{what is this information? and is it used?}
	\item Calibration signal yields a spike at 101.3 dBSPL $@$ 1 $k$Hz, the expected value is 93.6 dBSPL. Measured values requires a -7.7 dBSPL adjustment.
\end{itemize}
\subsubsection{Equipment settings}
\begin{itemize}
	\item This experiment is performed with a sampling rate of, $f_{s}$ = 48 $k$Hz.
	\item Outside microphone is placed 12.6 mm from headphone cup. 
	\item Settings for the Roland Edirol:
	\begin{itemize}
		\item "SENS(INPUT 1/L)" is set to +0 dB.
		\item "SENS(INPUT 2/R)" is set to +0 dB.
		\item "PHONES" is set to maximum volume. %\todoOliver{again max volume??}
	\end{itemize}		
	\item The measuring amplifier:
		\begin{itemize}
			\item "Input Section Gain" is set to +10 dB.
			% \todoOliver{so +10dB?? Write that }
			\item 22.4 $k$Hz low-pass filter is enabled.
			\item 22.4 Hz high-pass filter is enabled.
			 %\todoOliver{And very little sound is let through. Oliver: okay this doens't make much sense, but recordings are fine}
		\end{itemize}
	\item All gains on the computer is set to 0 dBFS.
\end{itemize}

\subsection{Pictures}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{CancellationPath_and_Headphones/CloseUpMicNew.jpg}
	\caption{Full set-up of experiment.}
	\label{CloseupHeadphone}
\end{figure}

%\begin{figure}[H]
%	\centering
%	\includegraphics[width=0.8\textwidth]{CancellationPath_and_Headphones/CloseUpMic.jpg}
%	\caption{Close up of experiment.}
%	\label{CloseUpCancellationPath}
%\end{figure}

\subsection{Procedure}
\subsubsection{Set-up}
\begin{enumerate}
	\item Set instruments to comply with the list in \ref{SettingsHeadPhones}.
	\item Calibrate the microphone using the calibrator.
	\item Place the headphone on the HATS.
	\item Connect the microphone to the preamplifier. 
	\item Connect the preamplifier to the measuring amplifier.
	\item Connect the measuring amplifier to the Roland Edirol. 
	\item Connect the Roland Edirol to the computer via USB.
	\item Connect the headphones to the phones output of the Roland Edirol.
\end{enumerate}

\subsubsection{Performing the experiment}
\begin{enumerate}
	\item Start Simulink and run file  \path{SimulinkSystemHeadPhone.slx}.
	\item The simulation outputs a logarithmic chirp from 20 Hz to 20,000 Hz with an amplitude of 0 dBFS over the span of five seconds.
	\item Record and save, and name "Mic[i].wav" and "Ref[i].wav"\footnote{[i] indicates the iteration of the experiment.}.
\end{enumerate}
Perform this experiment for a total of five times.
If  a drop-out in the recorded signals occurs, then discard that recording and redo the experiment for the current iteration.

\subsection{Data Extraction}
\begin{enumerate}
	%\item Place generated .wav-files in same folder as MATLAB\textsuperscript{\textregistered}-script "HeadPhoneScript.m".
	\item Open Matlab and run script \path{HeadPhoneScript.m}.
\end{enumerate}

From the performing of the experiment, ten files have been generated:
\begin{itemize}
	\item Mic1.wav, Mic2.wav, Mic3.wav, Mic4.wav and Mic5.wav.
	\item Ref1.wav, Ref2.wav, Ref3.wav, Ref4.wav and Ref5.wav.
\end{itemize}

These files are the results of performing the six second simulation which gives a number of 288,768 samples, for each generated .wav-file. 
%\todoOliver{Again - not 6*48000??} Oliver: Same answer as in CP.
The recorded HPMic1 and HPRef1 are shown in \autoref{HeadPhoneAmplitudePlot}.

%\begin{figure}[H]
%	\centering
%	\includegraphics[width=0.85\textwidth]{HeadPhone_MATLAB_Figures/HeadPhoneAmplitudePlot.png}
%	\caption{Amplitude plot of the headphones (NOT TIKZ).}
%	\label{HeadPhoneAmplitudePlot}
%\end{figure}

\begin{figure}[H]
	\centering
	\tikzsetnextfilename{HeadPhoneAmplitudePlot2}
	\input{figures/HeadPhone_MATLAB_Figures/HeadPhoneAmplitudePlot2.tex}
	\caption{Time plot of the cancellation path with the headphone reference signal (blue) and the headphone microphone signal (orange).}
	\label{HeadPhoneAmplitudePlot}
\end{figure}


\subsection{Analysis}
The impulse response of the CP is to be found.
There is a 180$^\circ$ phase difference between pre- and external polarized microphones, i.e. a positive pressure leads to negative voltage. Therefore the externally polarized microphone signal is counterphase to the loopback. \cite{michandbook}

%First the cross correlation between Mic[i] and Ref[i] is found. This is done by cross correlating the two signals signals. Secondly the signal is taken into the frequency domain by applying the FT to the signal. This is expressed in \autoref{FrequencyResponseCPEq2}.
To extract the frequency response the method described in \autoref{Sec:MeasATransFunc} is used.


The frequency response of the headphones transfer function is shown at \autoref{HeadPhoneFrequencyResponsePlot}.

\begin{figure}[H]
	\centering
	\tikzsetnextfilename{HeadPhoneFrequencyResponse2}
	\input{figures/HeadPhone_MATLAB_Figures/HeadPhoneFrequencyResponse3.tex}
	\caption{Frequency response plot of the headphone transfer function. Frequency response 1 (\textcolor{MATLABblue}{---}), 
	frequency response 2 (\textcolor{MATLABorange}{---}), 	
	frequency response 3 (\textcolor{MATLAByellow}{---}), 	
	frequency response 4 (\textcolor{MATLABpurple}{---}), 	
	frequency response 5 (\textcolor{MATLABgreen}{---}).}
	\label{HeadPhoneFrequencyResponsePlot}
\end{figure}




The impulse responses of this system is found by taking the IFT of the frequency responses.
The impulse responses are shown on \autoref{HeadPhoneImpulseResponse}.


\begin{figure}[H]
	\centering
	\tikzsetnextfilename{HeadPhoneImpulseResponse2}
	\input{figures/HeadPhone_MATLAB_Figures/HeadPhoneImpulseResponse2.tex}
	\caption{Impulse response of the headphone transfer function. Impulse response 1 (\textcolor{MATLABblue}{---}), 
	impulse response 2 (\textcolor{MATLABorange}{---}), 	
	impulse response 3 (\textcolor{MATLAByellow}{---}), 	
	impulse response 4 (\textcolor{MATLABpurple}{---}), 	
	impulse response 5 (\textcolor{MATLABgreen}{---}).}
	\label{HeadPhoneImpulseResponse}
\end{figure}

%\begin{figure}[H]
%	\centering
%	\tikzsetnextfilename{CancellationPathImpulseResponse}
%	\input{figures/CancellationPath_MATLAB_Figures/CancellationPathImpulseResponse.tex}
%	\caption{Frequency Response plot of the cancellation path}
%	\label{CancellationPathImpulseResponse}
%\end{figure}

%Converting the impulse response from magnitude to dB, gives the time decay which reveals the SNR  of the system, see \autoref{TimeDecayPlotHeadphone}, and from the read off SNR is found to be $\sim$ 30 dB SNR. \todoOliver{agian - does this make sense?}

% \begin{figure}[H]
% 	\centering
% 	\tikzsetnextfilename{TimeDecayHP}
% 	\input{figures/HeadPhone_MATLAB_Figures/TimeDecayHP.tex}
% 	\caption{Five iterations of time decay-test plotted of the headphone transfer-function}
% 	\label{TimeDecayPlotHeadphone}
% \end{figure}
% \todoOliver{There is a hole in this plot? At least I have one?? missing data from 0  to 0.01
% Oliver: Yeah it's from reducing the plot when tikzing, not sure what can be done about it, Mikkel: No...?}
% \todoMikkel{Can you fix it? otherwise tikz is a NO GO!}

Taking the first 256 coefficients of the impulse response gives the following cropped impulse response, as seen on \autoref{fig:ImpRespCropHP}.

\begin{figure}[H]
	\centering
	\tikzsetnextfilename{HPFIR}
	\input{figures/HeadPhone_MATLAB_Figures/ImpRespCropHP.tex}
	\caption{Cropped impulse responses of the five iterations. Impulse response 1 (\textcolor{MATLABblue}{---}), 
	impulse response 2 (\textcolor{MATLABorange}{---}), 	
	impulse response 3 (\textcolor{MATLAByellow}{---}), 	
	impulse response 4 (\textcolor{MATLABpurple}{---}), 	
	impulse response 5 (\textcolor{MATLABgreen}{---}).}
	\label{fig:ImpRespCropHP}
\end{figure}

Test 2's result are used for further test. To verify that the frequency response of the cropped impulse response approximately equals that of the non-cropped impulse response the two frequency responses are compared. This can be seen on \autoref{fig:CompImpHP}.

\begin{figure}[H]
	\centering
	\tikzsetnextfilename{FreqCompHP}
	\input{figures/HeadPhone_MATLAB_Figures/CompHpImp.tex}
	\caption{Comparison of the frequency response of 256 coefficients (blue) vs. 288,768 coefficients (orange).}
	\label{fig:CompImpHP}
\end{figure}

%From \autoref{fig:CompImpHP} it can be concluded that 256 coefficients is sufficient.


\subsection{Error Sources/Tolerances}
\begin{itemize}
	\item Measurements conducted using a microphone clip with swing arm in horizontal position. Error within $\pm$ 0.5 dB. \citep{BK1985}. 
	\item Instrument tolerances see \autoref{TolerancesHP}.
% \todoOliver{Did they move? Who moved them?? If they didn't move don't write this}
%	\item Low-frequency background noise (Under 50 Hz reflections starts appearing in the anechoic chamber but it's not our scope).
\end{itemize}

\begin{table}[H]
	\centering
	\ra{1.3}
	\begin{tabular}{ c c c } \toprule
	{Item}	& 		{Description} 							& {Tolerance}\\ \bottomrule 
		2	&	B\&K 1'' Condenser Microphone Type 4179 	& $\pm$ 1.0 dBSPL 	\cite{BK4179_2660Tol}		\\
		3	&	Sennheiser HDA 200 Headphones				& $\pm$ 3.0 dBSPL	\cite{HDA200Tol}	\\
		4	&	Roland Edirol UA-25EX Audio Capture			& $+$ 0.0/$-$ 1.0 dB	\cite{UA25EXTol}	\\
		6	&	B\&K Measuring Amplifiers Type 2636			& $\pm$ 0.5 dB	\cite{BK2636Tol}	\\
		7	&	B\&K Sound Calibrator Type 4230				& $\pm$ 0.2 dBSPL	\cite{BK4231Tol}	\\ 
		8	&	B\&K 1'' Microphone Preamplifier Type 2660	& $\pm$ 0.1 dB	\cite{UA25EXTol}	\\ \bottomrule
			&	Total tolerance								& $+$ 4.8/$-$ 5.8	dBSPL	\\ \bottomrule	
	\end{tabular}
	\caption{Table showing tolerances for used equipment.}
	\label{TolerancesHP}
\end{table}

\subsection{Conclusion}
It can be concluded that an impulse response of 256 coefficients, see \autoref{fig:ImpRespCropHP}, is found for the 'headphone transfer function'. However 256 coefficients are not sufficient to represent 50 Hz.    
%\todoOliver{I disagree. The 256 coefficients are about 10dB off at 50 Hz - that's too much!
%Oliver: yeah, this we probably need to discuss}