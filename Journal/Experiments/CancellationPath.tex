\section{Cancellation path}
\subsection{Purpose}
The purpose of this experiment is to determine the impulse response of the cancellation path, i.e. the transfer-function between the "source-loudspeaker" and the "error-microphone (ear)".
		
\subsection{AAU number list}
\begin{table}[h]
	\centering
	\ra{1.3}
	\begin{tabular}{ c c c } \toprule
		{Item}	& {Description} 						& {AAU-no}. \\ \bottomrule 
		1	&	B\&K Head And Torso Simulator "Henry" Type 4128	& 08453		\\
		2	&	B\&K Ear Simulator Type 4159			& 08453		\\
		3	&	Sennheiser HD 200	Headphones			& 33379		\\
		4	&	Roland Edirol UA-25EX Audio Capture		& 64696		\\
		5	&	Vision B3565 Computer					& NaN		\\
		6	&	B\&K Microphone Power Supply Type 2804	& 07304		\\
		%5	&	B\&K \textonehalf'' Condenser Microphone Type 4134 & 61447\\
		%6	&	B\&K Sound Calibrator Type 4231			& 78301		\\ 
		7	&	B\&K Sound Intensity Calibrator Type 3541	& 08597	\\ \bottomrule
	\end{tabular}
	\caption{Table over equipment used in test.}
	\label{tab:UsedEquipmentListningCP}
\end{table}

\subsection{Diagrams}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\textwidth]{Shematic_CalcellationPath.pdf}
	\caption{Total overview of the system.}
	\label{SchematicOverview}
\end{figure}

\subsection{Settings/Description}
\label{SettingsCacellationPath}

Calibration of the microphone and associated preamplifier is done on the computer using Simulink\textsuperscript{\textregistered}, but any other method can be used. The following setting is present:

\subsubsection{Control and calibration}
\begin{itemize}
	\item 93.2 dB $@$ 250 Hz is used as calibration signal
	\item Microphone sensitivity is controlled to 11.6 $m$V/Pa
	\item Calibration signal yields an amplitude of 0.6 relative to 0 dBFS
\end{itemize}

\subsubsection{Equipment settings}
\begin{itemize}
	\item This experiment is performed with a sampling rate of, $F_{s}$ = 24,000 Hz
	\item Item 4 (sound capture card):
		\begin{itemize}
			\item "SENS(INPUT 1/L)" is set to +0 dB"
			\item "SENS(INPUT 2/R)" is set to +0 dB"
			\item "PHONES" is set to maximum volume
		\end{itemize}		
	\item Item 5 (computer) is set to 0 dBFS
\end{itemize}


\subsection{Pictures}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{CancellationPath_and_Headphones/FullSetup.jpg}
	\caption{Full setup of experiment (Note that "outside" microphone is not in use in the experiment).}
	\label{FullSetupCancellationPath}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{CancellationPath_and_Headphones/CloseUpFace.jpg}
	\caption{Close up of experiment(Note that external microphone is not in use in the experiment).}
	\label{CloseUpCancellationPath}
\end{figure}

\subsection{Procedure}
\subsubsection{Set-up}
\begin{enumerate}
	\item Set instruments to comply with the list in \ref{SettingsCacellationPath}
	\item Control, and if necessary, calibrate item 2 using item 7
	\item Place item 3 onto item 1 ("Henry"'s head and ears)
	\item Insert item 2's connector into input of item 6
	\item Connect item 6 to item 4 and connect item 4 to item 5 via USB
	\item Insert item 3's connector into output of item 4
	\item Connect cable from item 4's output to item 4's input
\end{enumerate}

\subsubsection{Performing the experiment}
\begin{enumerate}
	\item Open Simulink\textsuperscript{\textregistered} and open and run file "SimulinkSystemCancellationPath.xls"
	\begin{itemize} 
		\item The simulations outputs a logarithmic chirp from 20 Hz to 20,000 Hz at 0 dBFS over the span of five seconds
		\item The simulation runs for six seconds
	\end{itemize}
	%\item Through Simulink\textsuperscript{\textregistered} play "LogChirp.wav" from item 5 via item 4
	\item Rename outputted file "Mic" and "Ref" to "Mic[i].wav" and Ref[i].wav" \footnote{[i] indicates the iteration of the experiment}
	\begin{itemize}
		\item[] Perform this experiment for a total of 5 times
	\end{itemize}
\end{enumerate}


\subsubsection{Data Extraction}
\begin{enumerate}
	%\item Place generated .wav-files in same folder as MATLAB\textsuperscript{\textregistered}-script "CancellationPathScript.m".
	\item Open MATLAB\textsuperscript{\textregistered} and run script "CancellationPathScript.m"
\end{enumerate}
This should yield the resulting frequency response, impulse response and finally the transfer function, along other information about the cancellation-path in this set-up.

\subsection{Analysis}
%In MATLAB\textsuperscript{\textregistered} the script performs a series of mathematical operations. In short it loads all generated .wav-files and finds the mean. This mean of all measured signals is used to generate an amplitude plot of both the reference signal (the signal looped back from and to the Sound Capture Card) and the signal from the microphone (item 2).

From the performing of the experiment, 10 files has been generated:
\begin{itemize}
	\item Mic1.wav - Mic5.wav
	\item Ref1.wav - Ref5.wav
\end{itemize}

These files are the results of performing the six second simulation which gives a number of 288,768 samples, for each generated .wav-file.
An example showing outputted Mic1 and Ref1 are shown in  \autoref{AmplitudePlotCancellationPath}.

\begin{figure}[H]
	\centering
	\tikzsetnextfilename{CancellationPathAmplitudePlot}
	\input{figures/CancellationPath_MATLAB_Figures/CancellationOutput.tex}
	%\includegraphics[width=0.65\textwidth]{CancellationPath_MATLAB_Figures/CancellationPathAmplitudePlot.png}
	\caption{Amplitude plot of the cancellation path.}
	\label{AmplitudePlotCancellationPath}
\end{figure}

Here the frequency response of the cancellation path is to be found. This is defined as the FT (Fourier Transform) of the cross correlation between Mic[i] and Ref[i] and is given by:

%\begin{figure}[H]
%	\centering
%	\tikzsetnextfilename{Thisisatest}
%	\input{figures/CancellationPath_MATLAB_Figures/lineplotreducer.tex}
%	\caption{Amplitude plot of the cancellation path.}
%	\label{Thisisatest}
%\end{figure}


\begin{equation}
\label{FrequencyResponseEq}
%H(f) = \frac{Y(m_{\mu}) *  X(r_{\mu})}{X(r_{\mu}) *  X(r_{\mu})}
H(f) = \frac{Y(f) \cdot X\textsuperscript{*}(f)}{X(f) \cdot X\textsuperscript{*}(f)}
\end{equation}
Where:
\begin{itemize}
	%\item " $*$ " denotes the complex conjugation
	\item $H(f)$ is the FT of the 'Cancellation Path'
	\item $Y(f)$ is the recorded microphone signals, Mic[i]
	\item $X(f)$ is the recorded reference signals, Ref[i]
\end{itemize}

The frequency response of the calcellation path is shown at \autoref{FrequencyResponsePlotCancellationPath}.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.65\textwidth]{CancellationPath_MATLAB_Figures/CancellationPathFrequencyResponse.png}
	\caption{Frequency Response plot of the cancellation path (NOT TIKZ).}
	\label{FrequencyResponsePlotCancellationPath}
\end{figure}

The impulse response of this system is found by taking the IFT (Inverse Fourier Transform) of the frequency response.
The impulse response looks as shown on \autoref{CancellationPathImpulseResponse}.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.65\textwidth]{CancellationPath_MATLAB_Figures/CancellationPathImpulseResponse.png}
	\caption{Impulse Response plot of the cancellation path (NOT TIKZ).}
	\label{CancellationPathImpulseResponse}
\end{figure}

From the impulse response 


\subsection{Error Sources}
\begin{itemize}
	\item Placement of the actuators and test-devices
	\item Instrument inaccuracies see \autoref{TolerancesCP}
	\item Movement of instruments
	\item Low-frequency background noise
\end{itemize}

\begin{table}[h]
	\centering
	\ra{1.3}
	\begin{tabular}{ c c l } \toprule
		{Item}	& 		{Description} 	& {Tolerance ([dB])}.	 \\ \bottomrule 
		2	&	B\&K Ear Simulator Type 4159				& $\pm$ 1.5 	\\
		%3	&	Sennheiser HD 200 Headphones				& x		\\
		4	&	Roland Edirol UA-25EX Audio Capture			& $\pm$ 1.0	\\
		%6	&	B\&K Microphone Power Supply Type 2804		& 2 \%	\\ 
		7	&	B\&K Sound Intensity Calibrator Type 3541	& $\pm$ 0.2	\\ \bottomrule
			&	Total tolerance								& $\pm$ 2.7	\\ \bottomrule	
	\end{tabular}
	\caption{Table showing error tolerances for used equipment.}
	\label{TolerancesCP}
\end{table}











\subsection{Conclusion}
We done did it