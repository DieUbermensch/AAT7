\section{DT770 Cancellation Path Impulse Response} \label{sec:DT770CPjournal}
\subsection{Purpose}
The purpose of this experiment is to make a model of the CP, by determining its impulse response of the, i.e. the transfer-function between the "source-loudspeaker" and the "error-microphone (ear)".
		
\subsection{AAU number list}
\begin{table}[h]
	\centering
	\ra{1.3}
	\begin{tabular}{ c c c } \toprule
		{Item}	& {Description} 						& {AAU-no}. \\ \bottomrule 
		1	&	B\&K Head And Torso Simulator "Henry" Type 4128	& 08453		\\
		2	&	B\&K Ear Simulator Type 4159			& 08453		\\
		3	&	beyerdynamic DT 770	Headphones			& 33379		\\
		4	&	Knowles FG-23329 microphone					& NaN		\\
		5	&	Preamp for FG-23329  microphone	& NaN\\
		6	&	Roland Edirol UA-25EX Audio Capture		& 64696			\\
		7	&	Computer					& NaN		\\
		8	&	B\&K Microphone Power Supply Type 2804 	& 07304		\\
		%5	&	B\&K \textonehalf'' Condenser Microphone Type 4134 & 61447\\
		%6	&	B\&K Sound Calibrator Type 4231			& 78301		\\ 
		9	&	B\&K Sound Intensity Calibrator Type 3541	& 08597	\\ \bottomrule
	\end{tabular}
	\caption{Table over equipment used in test.}
	\label{tab:UsedEquipmentListningCP}
\end{table}

\subsection{Diagrams}
\begin{figure}[H]
	\centering
	\tikzsetnextfilename{figureexperimentDT770}
	\includegraphics[width=\textwidth]{figures/DT700CancellationPath/newcancellationpath.pdf}
%	\includegraphics[width=0.7\textwidth]{Shematic_CalcellationPath.pdf}
	\caption{Total overview of the system.}
	\label{SchematicOverviewCP}
\end{figure}

\subsection{Settings/Description}
\label{SettingsCacellationPath}

Calibration of the microphone and associated preamplifier is done on the computer using Simulink\textsuperscript{\textregistered}. The following settings are present:

\subsubsection{Control and calibration}
\begin{itemize}
	%\item Microphone sensitivity is controlled to 11.6 $m$V/Pa.
	\item Error microphone calibration signal yields a spike of 61 dB SPL @1000 Hz, the expected value is 95,6 dB which then requires a +34.6 dB SPL adjustment.
	\item Reference micro calibration signal yields a spike of 66.07 dB SPL @1000 Hz, the expected value is 94 dB which then requires a +28 dB SPL adjustment.
\end{itemize}


\subsubsection{Equipment settings}
\begin{itemize}
	\item This experiment is performed with a sampling rate of, $f_{s}$ = 48 $k$Hz.
	\item The Roland Edirol:
		\begin{itemize}
			\item "SENS(INPUT 1/L)" is set at half value (pointing upwards).
			\item "SENS(INPUT 2/R)" is set at half value (pointing upwards).
			\item "PHONES" is set at half value (pointing upwards)
		\end{itemize}				
	\item All gains on the computer is set to 0 dBFS.
\end{itemize}


\subsection{Pictures}
%\begin{figure}[H]
%	\centering
%	\includegraphics[width=0.8\textwidth]{CancellationPath_and_Headphones/FullSetup.jpg}
%	\caption{Full setup of experiment (Note that "outside" microphone is not in use in the experiment).} 
%	\label{FullSetupCancellationPath}
%\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{DT700CancellationPath/DT770CP.jpg}
	\caption{Close up of experiment.}
	\label{DT770CloseUpCancellationPath}
\end{figure}
\newpage
\subsection{Procedure}
\subsubsection{Set-up}
\begin{enumerate}
	\item Set instruments to comply with the list in \ref{SettingsCacellationPath}.
	\item Calibrate the ear simulator 2 using the calibrator.
	\item Calibrate the error microphone using the calibrator.
	\item Place the headphone onto the head and torso simulator.
	\item Insert the head and torso's connector into input of the microphone power supply.
	\item Connect the error microphone to the pre-amplifier
	\item Connect the soundcard to the computer.
	\item Insert the microphone power supply output connector into input1/L of the soundcard
	\item Insert the error microphone pre-amplifier output connector into input1/R of the soundcard.
	\item connect the headphone into the phones output of the soundcard.
\end{enumerate}


\subsubsection{Performing the experiment}
\begin{enumerate}
	\item Start Simulink\textsuperscript{\textregistered} and open and run file \path{SimulinkSystemCancellationPath.xls}.
	\begin{itemize} 
		\item The simulations outputs a logarithmic chirp from 20 Hz to 20,000 Hz with an amplitude of 0 dBFS over the span of five seconds.
		\item The simulation runs for 7 seconds. 
	\end{itemize}
	%\item Through Simulink\textsuperscript{\textregistered} play "LogChirp.wav" from item 5 via item 4
	
	
\end{enumerate}

If a drop-out in the recorded signal(s) occurs, then discard that recording and redo the experiment.


\subsubsection{Data Extraction}
\begin{enumerate}
	%\item Place generated .wav-files in same folder as MATLAB\textsuperscript{\textregistered}-script "CancellationPathScript.m".
	\item Start MATLAB\textsuperscript{\textregistered} and run script \path{CancellationPathScript.m}.
\end{enumerate}
From performing of the experiment, two files have been generated:
\begin{itemize}
	\item errMic.wav 
	\item spmMic.wav
\end{itemize}

These files are the results of performing the six second simulation which gives a number of 336,896 samples, for each generated .wav-file.
The recorded errMic and spmMic is shown in  \autoref{DT770AmplitudePlotCancellationPath}.

\begin{figure}[H]
	\centering
	\tikzsetnextfilename{CancellationPathAmplitudePlot3DT770}
	%\input{figures/CancellationPath_MATLAB_Figures/Amplitudeplot2.tex}
	\input{figures/DT700CancellationPath/calib.tex}
	\caption{Time plot of the cancellation path with the spmMic signal(blue) and the errMic signal(orange).}
	\label{DT770AmplitudePlotCancellationPath}
\end{figure}

MATLAB\textsuperscript{\textregistered}-script \path{DT770CancellationPathScript.m} is used for data extraction and analysis.



\subsection{Analysis}
The impulse response of the CP is to be found.
Note that a the error microphone has a 180\textdegree phase inversion. Therefore all impulses are inverted. When the data is later used it should be inverted again to yield the correct phase. \cite{michandbook}

To extract the frequency response the method described in \autoref{Sec:MeasATransFunc} is used.

%First the cross correlation between Mic[i] and Ref[i] is found. This is done by cross correlating the two signals signals. Secondly the signal is taken into the frequency domain by applying the FT to the signal. This is expressed in \autoref{FrequencyResponseCPEq2}.
%
%
%
%\begin{equation}\label{FrequencyResponseCPEq2}
%%H(f) = \frac{Y(m_{\mu}) *  X(r_{\mu})}{X(r_{\mu}) *  X(r_{\mu})}
%H(f) = \frac{Y(f) \cdot X\textsuperscript{*}(f)}{X(f) \cdot X\textsuperscript{*}(f)}
%\end{equation}
%Where:
%\begin{description}
%	%\item " $*$ " denotes the complex conjugation
%	\item $H(f)$ is the FT of the CP.
%	\item $Y(f)$ is the FT of the recorded microphone signals, Mic[i].
%	\item $X(f)$ is the FT of the recorded reference signals, Ref[i].
%\end{description}

The frequency response of the CP is shown in \autoref{DT770FrequencyResponsePlotCancellationPath}.

\begin{figure}[H]
	\centering
	\tikzsetnextfilename{CancellationPathFrequencyResponseDT770}
	%\input{figures/CancellationPath_MATLAB_Figures/CP_freqresp.tex}
	\input{figures/DT700CancellationPath/freqresponse.tex}
	\caption{Frequency response plot of the cancellation path.}
	\label{DT770FrequencyResponsePlotCancellationPath}
\end{figure}

The impulse response of this CP is found by taking the inverse Fourier transform of the frequency response.
The impulse response is shown on \autoref{DT770CancellationPathImpulseResponse}.

\begin{figure}[H]
	\centering
	\tikzsetnextfilename{CancellationPathImpulseResponse2}
	%\input{figures/CancellationPath_MATLAB_Figures/CancellationPathImpulseResponse.tex}
	\input{figures/DT700CancellationPath/impulseresponsefull.tex}
	\caption{Impulse response plot of the cancellation path see \autoref{CancellationPathImpulseResponseCrop} for zoomed in version.}
	\label{DT770CancellationPathImpulseResponse}
\end{figure}


%\begin{figure}[H]
%	\centering
%	\includegraphics[width=0.85\textwidth]{CancellationPath_MATLAB_Figures/CancellationPathImpulseResponse.png}
%	\caption{Impulse Response plot of the cancellation path (NOT TIKZ).}
%	\label{CancellationPathImpulseResponse}
%\end{figure}

Converting the impulse response from magnitude to dB, gives the time decay which reveals the Signal to Noise Ratio (SNR) of the system, and from the read off SNR is found to be $\sim$ 40 dB SNR, as seen on \autoref{DT770TimeDecayPlotCancellationPath}.

%\begin{figure}[H]
%	\centering
%	\includegraphics[width=0.85\textwidth]{CancellationPath_MATLAB_Figures/CancellationPathTimeDecay.png}
%	\caption{Time decay plot of the cancellation path (NOT TIKZ).}
%	\label{TimeDecayPlotCancellationPath}
%\end{figure}

\begin{figure}[H]
	\centering
	\tikzsetnextfilename{TimeDecayPlotCancellationPath2}
	%\input{figures/CancellationPath_MATLAB_Figures/TimeDecayPlotCancellationPath.tex}
	\input{figures/DT700CancellationPath/snr.tex}
	\caption{Time decay plot of the cancellation path}
	\label{DT770TimeDecayPlotCancellationPath}
\end{figure}

Taking the first 960 coefficients of the impulse response gives a good reproduction of frequencies over 50Hz, therefore we choose to crop the impulse response and take the first 960 samples.
In order to have an idea of the impulse response,  \autoref{DT770CancellationPathImpulseResponseCrop} displays the first 200 samples of the impulse response.


\begin{figure}[H]
	\centering
	\tikzsetnextfilename{Impulseresponsecropped2}
	%\input{figures/CancellationPath_MATLAB_Figures/CancellationPathImpulseResponseCrop.tex}
	\input{figures/DT700CancellationPath/impulseresponse.tex}
	\caption{Cropped impulse response plot of the cancellation path}
	\label{DT770CancellationPathImpulseResponseCrop}
\end{figure}

To verify that the frequency response of the cropped impulse response approximately equals that of the non-cropped impulse response the two frequency responses are compared. This can be seen on \autoref{DT770CancellationPathImpulseResponseCompare}. Note that the two lines are almost completely on top of each other.

\begin{figure}[H]
	\centering
	\tikzsetnextfilename{CancellationPathImpulseResponseCompare3}
	%\input{figures/CancellationPath_MATLAB_Figures/CancellationPathImpulseResponseCompare.tex}
	\input{figures/DT700CancellationPath/compfilter.tex}
	\caption{Comparison of the frequency response of 256 coefficients vs. 288,768 coefficients.}
	\label{DT770CancellationPathImpulseResponseCompare}
\end{figure}

From \autoref{DT770CancellationPathImpulseResponseCompare}, 256 coefficients is shown to be sufficient for representing the impulse response with good accuracy. 

\subsection{Error Sources / Tolerances}
\begin{itemize}
	\item Placement of the actuators and test-devices. (Position of the headset on the ear  influence the frequency response at high frequency which is not the main scope of study).
	\item Instrument inaccuracies see \autoref{DT770TolerancesCP}.
\end{itemize}
\todoOliver{When you have fixed this in the other journals tell Max so he can fix it here}

\begin{table}[h]
	\centering
	\ra{1.3}
	\begin{tabular}{ c c c } \toprule
		{Item}	& 		{Description} 	& {Tolerance ([dB$_{re20\mu P}$])}.	 \\ \bottomrule 
		2	&	B\&K Ear Simulator Type 4159				& $\pm$ 1.5 	\\
		%3	&	Sennheiser HD 200 Headphones				& x		\\
		4	&	Roland Edirol UA-25EX Audio Capture			& $\pm$ 1.0\\
		%6	&	B\&K Microphone Power Supply Type 2804		& 2 \%	\\ 
		7	&	B\&K Sound Intensity Calibrator Type 3541	& $\pm$ 0.2	\\ \bottomrule
			&	Total tolerance								& $\pm$ 2.7	\\ \bottomrule	
	\end{tabular}
	\caption{Table showing error tolerances for used equipment.}
	\label{DT770TolerancesCP}
\end{table}

\subsection{Conclusion}
It can be concluded that an impulse response in the form of 256 coefficients, see \autoref{DT770CancellationPathImpulseResponse}, is found for the "Cancellation path".
%The impulse response on  shows the coefficients of the system, and a file containing all 256 is generated with the name "CoeffientsCP.mat"