\section{Design and Test FIR Filter Function}

This section describes the design method and tests an FIR assembler function. The filter code can be found implemented in the DSP code, found in appendix: \


\subsection{Purpose}
The purpose of this test is to design and test an assembly written FIR function. The Filter were to be used if implemented on a DSP platform. With the function written in assembler it is possible to optimize the amount of instructions used. 


\subsection{Design of the filter algorithm}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.6\textwidth]{../Journal/Code/FIRfilter}
	\caption{Diagram of FIR filter\cite{FIRWiki}}
	\label{Fig:FIR_filter2}
\end{figure}

The FIR filter is designed based on the flowchart seen in figure \ref{Fig:FIR_filter2}. The filter structure is chosen as a Type 1 FIR filter, meaning symmetrical and even. The variables are declared in C, since this creates a better overview and is not computational critical. The declaration can be shown in listing \ref{lst:variablesFIR}. The convolution is created in assembler and can be seen in listing \ref{lst:FIR}

\subsubsection{variables}
The variables declared are used to store input values, filter coefficients and the order. 
\begin{lstlisting}[language={C},caption={declaration of the needed variables}, label={lst:variablesFIR} ]
Int16 	*x 		//The input signal
Int16	*b		//The filter coefficients
Int16	order	//The order of the filter (length of x & b)
Int16	index	//The index of the newest x sample
Int16	return	//Returns the output of the filter (y(n))
\end{lstlisting}

Using the syntax in code composer the values will be passed into the assembler function, the syntax for passing into assembler is shown in listing \ref{lst:SyntaxFIR}.
\begin{lstlisting}[language={C},caption={Function }, label={lst:SyntaxFIR}]
extern Int16 FIR(Int16 *x, Int16 *b, Int16 order, Int16 index);
\end{lstlisting}
The values from the function will be placed in the following registers, shown in table \ref{tab:Assemblerpassing}

\begin{table}[H]
	\centering
	\begin{tabular}{c|cccc}
		Variable & *x & *b & N & i \\ \hline
		Register & AR0 & AR1 & T0 & T1
	\end{tabular} 
	\caption{Placement of variables into assembler function}
	\label{tab:Assemblerpassing}
\end{table}


\subsubsection{code}
listing \ref{lst:FIR} shows the convolution of the signal. The filter is running sample by sample, which means it will continuously output the i'th sample in accordance to a counter running in the main program.  
\begin{lstlisting} [language={[x86masm]Assembler},caption={The FIR Convolution with N ammount of coefficients}, label={lst:FIR}]
.global _FIR;				; Declare function 

_FIR:	
MOV #0, AC0					; Clear AC1
MOV mmap(AR0),BSA01			; Set base Adress for buffer
MOV mmap(T0), BK03			; Set buffer size to filter order
MOV *(#T1),AR0				; Start from ith sample
bset AR0LC					; Set pointer as circular
SUB #1,T0					; Setup Repititions
MOV T0,CSR					; Setup Repititions
RPT CSR						; Repeat order times
MAC *AR0-,*AR1+,AC0 		; Do filter convolution
SFTL AC0, #-15				; Bit shift to fit Q15
MOV AC0,T0					; Output sample
RET
\end{lstlisting}



\subsection{Test of the filter}
A filter is designed in MATLAB\textsuperscript{\textregistered},for testing. The design of the filter is done with any specific attenuation in mind, it is merely done to test if the same response is replicated on the DSP. Hence a windowing design method is used in MATLAB\textsuperscript{\textregistered}.

%By running \path{PerformFIRExperiment.m} filter coefficients are determined, and a filter is designed as such:

\begin{itemize}
	\item Characteristic: Kaiser window FIR filter with a $\beta$ value of 2
	\item Order = 16
	\item Fs = 48 $k$Hz
\end{itemize}


And yielding the following magnitude response, as seen on \autoref{Fig:FIRComparison}. 

%\begin{lstlisting} [language={[x86masm]Assembler}, caption=The 17 double-precision 16-bit filter-coefficients generated by MATLAB\textsuperscript{\textregistered}'s 'fdatool'., label=Lst:fdafiltercoefs]
%0.05495103040004,	0.05636924343443,	0.05762079784516,	0.05869629010148,
%0.05958760141172,	0.06028797732014,	0.0607920940819,	0.06109611107473,
%0.06119770866076,	0.06109611107473,	0.0607920940819,	0.06028797732014,
%0.05958760141172,	0.05869629010148,	0.05762079784516,	0.05636924343443,
%0.05495103040004
%\end{lstlisting}


This generates a Direct-Form 1 with 17 filter-coefficients and is double-precision with floating point. However this is not implementable on the selected DSP as it operates in fixed-point. This is why to compare this generated filter and the implementation, the generated filter is then quantized into Q15 format.

%\begin{lstlisting} [language={[x86masm]Assembler}, caption=The 17 Q15 filter-coefficients., label=Lst:fdafiltercoefsquantized]
%0.0550,	0.0564,	0.0576,	0.0587,	0.0596,	0.0603,	0.0608,	0.0611,	0.0612,
%0.0611,	0.0608,	0.0603,	0.0596,	0.0587,	0.0576,	0.0564,	0.0550
%\end{lstlisting}

The Q15 coefficients are converted into hexadecimal values, in order to implement them on the DSP for testing, as seen in \autoref{Lst:fdafiltercoefsquantizedhex} 

\begin{lstlisting} [language={[x86masm]Assembler}, caption=The 17 Q15 filter-coefficients in hexadecimal., label=Lst:fdafiltercoefsquantizedhex]
0x028C,  0xFE22,  0xF9BA,  0xF8B2,  0xFD5E,  0x078C,  0x1433,  0x1EA2,  0x22AB,  
0x1EA2,  0x1433,  0x078C,  0xFD5E,  0xF8B2,  0xF9BA,  0xFE22,  0x028C
\end{lstlisting}

%0x709,	0x737,	0x760,	0x783,	0x7A1,	0x7B8,	0x7C8,	0x7D2,	0x7D5,
%0x7D2,	0x7C8,	0x7B8,	0x7A1,	0x783,	0x760,	0x737,	0x709


\subsection{AAU number list}
The table in \ref{tab:UsedEquipmentListningFIRTest} shows the equipment used to perform the FIR test.
\begin{table}[H]
	\centering
	\ra{1.3}
	\begin{tabular}{ c c c } \toprule
	{Item}	& {Description} 								& {AAU-no}. 	\\ \bottomrule 
	1	&	Computer w. NI-PCI-4461 using Swept Sine FRF VI	& NaN			\\
	2	&	DSP freedom board rev. 1 						& NaN			\\
	3	&	Computer running Code Composer Studio			& 2037-18		\\
	4	&	TMSC5515 eZDSP 									& NaN			\\
	\bottomrule
	\end{tabular}
	\caption{Table over equipment used in test.}
	\label{tab:UsedEquipmentListningFIRTest}
\end{table}

\subsection{Diagram \& setup}

The DSP is connected according to figure \ref{Fig:FIRSetupDiagram}, where the NI-PCI-4461 will sweep a sine wave measuring the input according to the output and compare the result

\begin{figure}[H]
	\centering
	\includegraphics{../Journal/Experiments/Figures/FIRFilterTestSetup}
	\caption{Diagram of the set-up.}
	\label{Fig:FIRSetupDiagram}
\end{figure}

\subsection{Pictures}
\begin{figure}[H]
	\centering
	\begin{subfigure}[b]{.495\textwidth}
		\centering
		\includegraphics[width=\textwidth]{../Journal/Experiments/Figures/Fullsetup1}
		\caption{Computer running the application.}
		\label{fig:FIRFullSetup1}
	\end{subfigure} 
	\begin{subfigure}[b]{.495\textwidth}
		\centering
		\includegraphics[width=\textwidth]{../Journal/Experiments/Figures/Fullsetup2}
		\caption{The DSP loaded with the FIR-filter}
		\label{fig:FIRFullSetup2}
	\end{subfigure}
	\caption{Overall set-up of the experiment.}
		\label{fig:FIRFullSetup}
\end{figure}


\subsection{Procedure}\label{Eqp_Sett_FIR}

The measuring system on the computer are used with the following settings,
\begin{itemize}
	\item Fs = 48000 Hz
	\item Sweep from 20 hz to 20 $k$Hz
	\item Vs = 0.5 V
	\item Steps = 2000
\end{itemize}

The DSP board is connected to the measuring system in the manner described below:
	\begin{itemize}
		\item Connect Item 1's "A0-0" to Item 2's "IN 1R"
		\item Connect Item 1's "A0-0" to Item 1's "A1-0"
		\item Connect Item 1's "A1-1" to Item 2's "OUT 1R"
	\end{itemize}
	
\subsubsection{Performing Experiment}
to perform a sine sweep on the DSP, the following step are to be made.
	\begin{enumerate}
		\item Upload filter to be tested onto DSP.
		\item Open "SineSweep" application.
		\begin{itemize}
			 \item Set instruments on Item 1 to comply with the list \autoref{Eqp_Sett_FIR}.
		\end{itemize}
		\item Press 'Start'.
		\item Save file as "SineSweepTest.txt" and include in FIRFIlterTest-foler.
	\end{enumerate}


\subsection{Data Extraction}
The data from the experiment is load as follows:
	\begin{enumerate}
		\item Open MATLAB\textsuperscript{\textregistered} and run script \path{SweptSineLoad.m} to extract and plot data from test
		\item Run \path{PerformFIRExperiment.m} to extract and plot data from generated and simulated filters
	\end{enumerate}

\autoref{Fig:FIRComparison} shows comparison between the designed quantized filter in MATLAB\textsuperscript{\textregistered} and the measured filter. The Blue graph shows the designed filter and the red graph shows the measured response. The phase response of the filter is not shown, since the FIR filter by nature is linear in phase.
	
%\begin{figure}[H]
%	\centering
%	\tikzsetnextfilename{Compared}
%	\input{../Journal/Experiments/Figures/Compared(fig).tex}
%	\caption{Magnitude response of: Q15-coefficients filter(Orange), filter generated by MATLAB\textsuperscript{\textregistered}'s 'fdatool'(Blue), test filter(Yellow)}
%	\label{Fig:FIRComparison}
%\end{figure}

% Graph tested with kaiser window and correct attenuation in the gain
\begin{figure}[H]
	\centering
	\tikzsetnextfilename{Testing}
	\input{figures/Hardware/FIRtest.tex}
	\caption{16-tap FIR filter with the kasier window applied using a 2 $\beta$ value.}
	\label{Fig:FIRComparison}
\end{figure}



\subsection{Conclusion}
The test yielded a $\approx$ 0.5 dB of difference on the main lope, and slight deviation and gain in the side lobes. The filter does however perform as desired with the designed filter coefficient and is assumed fully functional.



