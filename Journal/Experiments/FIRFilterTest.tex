\section{Test of FIR Filter Function}

\subsection{Purpose}
The purpose of this test is to compare the assembly FIR function. Using the performance of the filter to determine whether the function works as intended.

\subsection{Introduction}
First, a filter is designed in MATLAB\textsuperscript{\textregistered}, as a reference to the designed filter to be tested. By running "PerformFIRExperiment.m" the filter coefficients are determined using fdatool, and filters are designed as such:

A LP FIR Butterworth filter was designed using the following specifications:

\begin{itemize}
	\item $f_{cutoff} = 500$ Hz
	\item Order = 16
	\item Fs = 48 $k$Hz
\end{itemize}


And yielding the following magnitude response, as seen on \autoref{Fig:FIR_filterfdatool}.

\begin{lstlisting} [language={[x86masm]Assembler}, caption=The 17 double-precision 16-bit filter-coefficients generated by MATLAB\textsuperscript{\textregistered}'s 'fdatool'., label=Lst:fdafiltercoefs]
0.05495103040004,	0.05636924343443,	0.05762079784516,	0.05869629010148,
0.05958760141172,	0.06028797732014,	0.0607920940819,	0.06109611107473,
0.06119770866076,	0.06109611107473,	0.0607920940819,	0.06028797732014,
0.05958760141172,	0.05869629010148,	0.05762079784516,	0.05636924343443,
0.05495103040004
\end{lstlisting}


The output of this generated is Direct-Form with 17 filter-coefficients and is double-precision with floating point. However this is not implementable on the selected DSP as it operated in fixed-point. This is why to compare this generated filter and the implementation, the generated filter is then quantized into Q15 format. As seen from \autoref{Lst:fdafiltercoefs} to \autoref{Lst:fdafiltercoefsquantized}

\begin{lstlisting} [language={[x86masm]Assembler}, caption=The 17 Q15 filter-coefficients., label=Lst:fdafiltercoefsquantized]
0.0550,	0.0564,	0.0576,	0.0587,	0.0596,	0.0603,	0.0608,	0.0611,	0.0612,
0.0611,	0.0608,	0.0603,	0.0596,	0.0587,	0.0576,	0.0564,	0.0550
\end{lstlisting}

The Q15 coefficients are converted into hexadecimal values, in order to implement them on the DSP for testing, as seen in \autoref{Lst:fdafiltercoefsquantizedhex} 

\begin{lstlisting} [language={[x86masm]Assembler}, caption=The 17 Q15 filter-coefficients in hexadecimal., label=Lst:fdafiltercoefsquantizedhex]
0x709,	0x737,	0x760,	0x783,	0x7A1,	0x7B8,	0x7C8,	0x7D2,	0x7D5,
0x7D2,	0x7C8,	0x7B8,	0x7A1,	0x783,	0x760,	0x737,	0x709
\end{lstlisting}


\subsection{AAU number list}
\begin{table}[H]
	\centering
	\ra{1.3}
	\begin{tabular}{ c c c } \toprule
	{Item}	& {Description} 						& {AAU-no}. \\ \bottomrule 
	1	&	B\&K Head And Torso Simulator "Henry" Type 4128	& 08453	\\
	2	&	B\&K Â½'' Condenser Microphone Type 4134 	& 08130		\\
	3	&	Beyerdynamic DT 770 Headphones				& 2037-18		\\
	4	&	Soundcard RME Fireface 802					& 86838		\\
	5	&	Computer running simulink		& NaN		\\
	6	&	GRAS pre-amplifier type 26-AK			& 52665		\\
	7	&	B\&K Sound Calibrator Type 4230				& 08155		\\ 
	8	&	Knowles FG-23329 microphone					& NaN		\\
	9	&	Genelec speaker								& 33990		\\ 
	10	&	Preamp for FG-23329  microphone	& NaN\\
	11	& 	B\&K Microphone Power Supply Type 2804		& 07304		\\
	\bottomrule
	\end{tabular}
	\caption{Table over equipment used in test.}
	\label{tab:UsedEquipmentListningFIRTest}
\end{table}

\subsection{Diagram}
\begin{figure}[H]
	\centering
	\includegraphics{../Journal/Experiments/Figures/FIRFilterTestSetup}
	\caption{Diagram of the set-up.}
	\label{Fig:FIRSetupDiagram}
\end{figure}


\subsection{Settings/Description}
\subsubsection{Equipment settings}
\label{Eqp_Sett_FIR}
\begin{itemize}
	\item Fs = 48000 Hz
	\item Vs = 0.5 V
	\item Steps = 1000
\end{itemize}

\subsection{Pictures}
\begin{figure}[H]
	\centering
	\begin{subfigure}[b]{.495\textwidth}
		\centering
		\includegraphics[width=\textwidth]{../Journal/Experiments/Figures/Fullsetup1}
		\caption{Computer running the application.}
		\label{fig:FIRFullSetup1}
	\end{subfigure} 
	\begin{subfigure}[b]{.495\textwidth}
		\centering
		\includegraphics[width=\textwidth]{../Journal/Experiments/Figures/Fullsetup2}
		\caption{The DSP loaded with the FIR-filter}
		\label{fig:AngOgIndMicplace}
		\label{fig:FIRFullSetup2}
	\end{subfigure}
	\caption{Overall set-up of the experiment.}
		\label{fig:FIRFullSetup}
\end{figure}


\subsection{Procedure}
\subsubsection{Set-up}
	\begin{itemize}
		\item Connect Item 1's "A0-0" to Item 2's "IN 1R"
		\item Connect Item 1's "A0-0" to Item 1's "A1-0"
		\item Connect Item 1's "A1-1" to Item 2's "OUT 1R"
	\end{itemize}

\subsubsection{Performing Experiment}
	\begin{enumerate}
		\item Upload filter to be tested onto DSP.
		\item Open "SineSweep" application.
		\begin{itemize}
			 \item Set instruments on Item 1 to comply with the list \autoref{Eqp_Sett_FIR}.
		\end{itemize}
		\item Press 'Start'.
		\item Save file as "SineSweepTest.txt" and include in FIRFIlterTest-foler.
	\end{enumerate}


\subsection{Data Extraction}
	\begin{enumerate}
		\item Open MATLAB\textsuperscript{\textregistered} and run script "SweptSineLoad.m" to extract and plot data from test
		\item Run "PerformFIRExperiment.m" to extract and plot data from generated and simulated filters
	\end{enumerate}

\autoref{Fig:FIRComparison} shows comparison between all three filters.
	
\begin{figure}[H]
	\centering
	\tikzsetnextfilename{Compared}
	\input{../Journal/Experiments/Figures/Compared(fig).tex}
	\caption{Magnitude response of: Q15-coefficients filter(Orange), filter generated by MATLAB\textsuperscript{\textregistered}'s 'fdatool'(Blue), test filter(Yellow)}
	\label{Fig:FIRComparison}
\end{figure}

\subsection{Conclusion}
The test yielded a $\approx$ 0.3 dB of attenuation difference  at selected frequencies between the tested filter and the simulated filters.



