\section{Third octave filter bank} {\label{sec:OctaveBank}}

\todoMikkel{I know it is not finished, but it is finished Saturday}

This appendix contains documentation regarding the third octave filter bank used in the project. The scripts can be found in \path{CD://Appendix X...}
\\
To run the script MATLAB 2016b is required with the dsp-toolbox installed. 

\subsection{Purpose}

A third octave filter bank is designed to test the active noise cancellation headsets provided and to test the designed system. A third octave filter bank is used since the noise cancellation is not a time invariant system, hence a Fourier transform is not applicable for displaying a frequency response.

\subsection{Design}

The filter banks are designed and used with the following parameters:
\begin{itemize}
	\item Complies with ANSI S1.11-2004 class 0 filter banks
	\item Has a center frequency in 1 $k$Hz
\end{itemize}
The class 0 requirements are described in \cite{OctaveBand}, and is showed plotted in figure \ref{fig:1000KhzFilterClass0}. To accommodate these requirements the code described in listing \ref{lst:filterbanksSetup} is used.

\begin{lstlisting} [language=MATLAB, caption=Design of each filter using MATLAB, label={lst:filterbanksSetup}]
BW = '1/3 octave';	% Type of bandwidth
N = 8;           	% Filter Order
F0 = 1000;       	% Center Frequency (Hz)

ThirdoctaveFilter = octaveFilter('FilterOrder', N, ...
'CenterFrequency', F0, 'Bandwidth', BW, 'SampleRate', fs);
F0 = getANSICenterFrequencies(ThirdoctaveFilter);

F0(F0<20) = [];
F0(F0>20e3) = [];
Nfc = length(F0);

for i=1:Nfc
FilterBank{i} = octaveFilter('FilterOrder', N, ...
'CenterFrequency', F0(i), 'Bandwidth', BW, 'SampleRate', fs); 
end
\end{lstlisting}

listing \ref{lst:filterbanksSetup} calculates the need filter frequency response with a given order, the output is visualized in figure \ref{fig:1000KhzFilterClass0}. The response conforms with the wanted class 0 requirements. From the center frequency of 1 $k$Hz the correlating center frequencies for the other bands are determined.

\begin{figure}[H]
	\centering
	\tikzsetnextfilename{1000KhzFilterClass0}
	\input{figures/FilterBank/1000KhzFilterClass0.tex}
	\caption{A filter bank with center frequency in 1 $k$Hz displayed with class 0 mask requirements.}
	\label{fig:1000KhzFilterClass0}
\end{figure}

\subsection{Procedure}

The comparison of each ANC system is done by calculating the ratio,in each band, when the system is turned on and off respectively. 
\\
Listing \ref{lst:filterbanksProcedure} shows the procedure used to calculate each output of the filter. The filters takes the recorded signal as input and outputs the filtered response. An RMS value of each filter bank is then calculated. Using the RMS value of each band, the ratio of each signal is then determined. 

\begin{lstlisting} [language=MATLAB, caption=Calculation of each filter with averaging and comparison. The plotting code is removed in the listing, label={lst:filterbanksProcedure}]
for i=1:Nfc
  ThirdoctFilt = FilterBank{i};  
  yBasisoff(:,i) = ThirdoctFilt(Basisoff);
  yBasisOn(:,i) = ThirdoctFilt(BasisOn); 
  yLPoff(:,i) = ThirdoctFilt(LPoff);
  yLPon(:,i) = ThirdoctFilt(LPon);    
end
% Average the output of the filter and compare
rmsBasisoff = rms(yBasisoff);
rmsBasisOn  = rms(yBasisOn);
Difference(1,:)=-20*log10(rmsBasisOn./rmsBasisoff);
  
rmsLPoff = rms(yLPoff);
rmsLPon  = rms(yLPon);
Difference(2,:)=-20*log10(rmsLPon./rmsLPoff);
\end{lstlisting}

%When the ratio is determined, 
%
%\ref{lst:filterbanksPlot}
%
%\begin{lstlisting} [language=MATLAB, caption= Plotting each response with proper display of each band, label={lst:filterbanksPlot}]
%
%% Creating the offset:
%for e=1:length(F0)-1
%	F0Stair(e) = F0(e)- ((F0(e+1)-F0(e))/2);
%end
%F0Stair(length(F0)) = F0(length(F0))-((F0(length(F0))-F0(length(F0)-1))/2);
%
%% Plotting
%stairs(F0Stair,Difference(1,:)); axis([70 4000 -inf inf]);
%set(gca,'XScale','log');
%hold all
%stairs(F0Stair,Difference(2,:));
%\end{lstlisting}

\subsection{Test of algorithm}

To make sure the banks worked as expected a test was performed by applying two known signals time signal and displaying the output.
\vspace{-6mm}
\begin{itemize}
	\item An AM modulated wave containing:
	\begin{itemize}
		\item 100 Hz sine wave with an amplitude of '3'
		\item 1000 Hz sine wave with an amplitude of '1'
		\item 10000 Hz sine wave with an amplitude of '0.5'
	\end{itemize}
	\item Five second Pink noise
\end{itemize}
\vspace{-3mm}
The results is shown in figure \ref{fig:octresults}. Based on the results in figure \ref{fig:octresults} the third octave filter bank is assumed working as desired.
\begin{figure}[H]
	\centering
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
			\tikzsetnextfilename{Signal01k1k10k}
			\input{figures/FilterBank/Signal01k1k10k.tex}
		\caption{An AM modulated sine with a 100, 1.000 and 10.000 Hz tone}
		\label{fig:Signal01k1k10k}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
			\tikzsetnextfilename{OctFilter01k1k10k}
			\input{figures/FilterBank/OctFilter01k1k10k.tex}
		\caption{The output from the signal shown in figure \ref{fig:Signal01k1k10k}.}
		\label{fig:OctFilter01k1k10k}
	\end{subfigure}	
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
			\tikzsetnextfilename{PinkNoise5sec}
			\input{figures/FilterBank/PinkNoise5sec.tex}
		\caption{Five second pink noise}
		\label{fig:PinkNoise5sec}
	\end{subfigure}	
	\hfill
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
		\tikzsetnextfilename{OctFilterPink}
		\input{figures/FilterBank/OctFilterPink.tex}
		\caption{The output from the signal shown in figure \ref{fig:PinkNoise5sec}.}
		\label{fig:OctFilterPink}
	\end{subfigure}	
	\caption{Picture of setup and the specific schematic.}
	\label{fig:octresults}
\end{figure}
